var geojsonData={"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.062407,26.713406]},"properties":{"caseno":"13-1068","date":"10/8/2013","year":2013,"name":"Eddie Diaz","sex":"M","race":"W","age":"26","track":"CSX","type":"Accident","location":"Other","impairment":"Marijuana"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.074429,26.435716]},"properties":{"caseno":"10-0264","date":"3/8/2010","year":2010,"name":"Joseph David Jarboe","sex":"M","race":"W","age":"33","track":"FEC","type":"Accident","location":"Other","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.089500,26.340912]},"properties":{"caseno":"13-1008","date":"9/25/2013","year":2013,"name":"Thomas Lawrence Newman","sex":"M","race":"W","age":"69","track":"FEC","type":"Suicide","location":"Crossing","impairment":"Barbiturates"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.090242,26.336326]},"properties":{"caseno":"12-0437","date":"4/25/2012","year":2012,"name":"Leonor Rahas de la Cuervo","sex":"F","race":"W","age":"52","track":"FEC","type":"Accident","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.090063,26.337372]},"properties":{"caseno":"09-0072","date":"1/18/2009","year":2009,"name":"Clifford Zirk","sex":"M","race":"W","age":"54","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.120379,26.350729]},"properties":{"caseno":"13-0114","date":"1/26/2013","year":2013,"name":"Anthony William Carter","sex":"M","race":"B","age":"49","track":"CSX","type":"Accident","location":"Crossing (Vehicle)","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.089518,26.340724]},"properties":{"caseno":"13-0631","date":"6/7/2013","year":2013,"name":"Charslie Septembre","sex":"F","race":"B","age":"17","track":"FEC","type":"Suicide","location":"ROW","impairment":"No"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.087957,26.350550]},"properties":{"caseno":"12-0898","date":"9/10/2012","year":2012,"name":"Henry Farrell","sex":"M","race":"W","age":"49","track":"FEC","type":"Accident","location":"Crossing","impairment":"Was drunk; lived 1.5 miles away"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.081031,26.394563]},"properties":{"caseno":"11-0662","date":"7/14/2011","year":2011,"name":"Elaine Siegel","sex":"F","race":"W","age":"89","track":"FEC","type":"Suicide","location":"Crossing","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.086168,26.361748]},"properties":{"caseno":"13-0957","date":"9/9/2013","year":2013,"name":"Thomas Hennessy","sex":"M","race":"W","age":"59","track":"FEC","type":"Suicide","location":"Crossing","impairment":"Hydrocodone"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.120425,26.346907]},"properties":{"caseno":"12-1167","date":"11/28/2012","year":2012,"name":"Thomas Hatami","sex":"M","race":"W","age":"61","track":"CSX","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.090881,26.420304]},"properties":{"caseno":"12-0587","date":"6/12/2012","year":2012,"name":"Hunter Kepley","sex":"M","race":"W","age":"35","track":"CSX","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.090832,26.439455]},"properties":{"caseno":"10-0851","date":"8/16/2010","year":2010,"name":"Juan Roldan","sex":"M","race":"W","age":"78","track":"CSX","type":"Accident","location":"Crossing (Vehicle)","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.120505,26.352095]},"properties":{"caseno":"13-0689","date":"6/19/2013","year":2013,"name":"Susan Salerno","sex":"F","race":"W","age":"49","track":"CSX","type":"Suicide","location":"ROW","impairment":"Alcohol, lorazepam, oxycodone"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.072039,26.450811]},"properties":{"caseno":"13-0738","date":"7/6/2013","year":2013,"name":"Harry Etienne","sex":"M","race":"W","age":"33","track":"FEC","type":"Accident","location":"ROW","impairment":"Alcohol, marijuana"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.120379,26.350729]},"properties":{"caseno":"08-0882","date":"8/8/2008","year":2008,"name":"Euton Nehemiah Edwards","sex":"M","race":"B","age":"47","track":"CSX","type":"Accident","location":"Crossing (Vehicle)","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.090893,26.446876]},"properties":{"caseno":"12-0987","date":"10/3/2012","year":2012,"name":"Pierre Dulano Estimable","sex":"M","race":"B","age":"67","track":"CSX","type":"Accident","location":"Crossing (Vehicle)","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.066753,26.483829]},"properties":{"caseno":"12-0248","date":"3/11/2012","year":2012,"name":"Salvador Hernandez Torrez","sex":"M","race":"W","age":"44","track":"FEC","type":"Accident","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.070141,26.462592]},"properties":{"caseno":"11-0125","date":"2/7/2011","year":2011,"name":"Reynaldo Torres","sex":"M","race":"W","age":"25","track":"FEC","type":"Accident","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.105799,26.386515]},"properties":{"caseno":"12-0636","date":"6/28/2012","year":2012,"name":"Steverson Altidor","sex":"M","race":"B","age":"35","track":"CSX","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.091065,26.461506]},"properties":{"caseno":"08-0304","date":"3/8/2008","year":2008,"name":"Roosevelt Kendricks","sex":"M","race":"B","age":"47","track":"CSX","type":"Accident","location":"Crossing","impairment":"Cocaine, marijuana, alcohol"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.069635,26.601728]},"properties":{"caseno":"09-0400","date":"4/7/2009","year":2009,"name":"Marty Robert Armetta","sex":"M","race":"W","age":"43","track":"CSX","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.053721,26.57485]},"properties":{"caseno":"08-0108","date":"1/21/2008","year":2008,"name":"Daniel Havyar","sex":"M","race":"W","age":"37","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.068931,26.621984]},"properties":{"caseno":"11-0383","date":"4/18/2011","year":2011,"name":"Steven Bianchini","sex":"M","race":"W","age":"45","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.052332,26.590752]},"properties":{"caseno":"14-0395","date":"4/7/2014","year":2014,"name":"Robert Starke","sex":"M","race":"B","age":"37","track":"FEC","type":"Accident","location":"ROW*","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.054742,26.596227]},"properties":{"caseno":"11-1037","date":"11/3/2011","year":2011,"name":"Edward Sligh","sex":"M","race":"B","age":"80","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.667292,26.725762]},"properties":{"caseno":"12-0326","date":"3/30/2012","year":2012,"name":"Arlene Gallo","sex":"F","race":"W","age":"61","track":"Sugar","type":"Accident","location":"Crossing (Vehicle)","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.055492,26.597616]},"properties":{"caseno":"10-1041","date":"10/6/2010","year":2010,"name":"Mark McDonald","sex":"M","race":"B","age":"44","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.070084,26.462971]},"properties":{"caseno":"09-0687","date":"6/20/2009","year":2009,"name":"Ronald Mitchel Maki","sex":"M","race":"W","age":"56","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.052256,26.589079]},"properties":{"caseno":"08-0606","date":"5/23/2008","year":2008,"name":"Marie Guerda Elan","sex":"F","race":"B","age":"37","track":"FEC","type":"Accident","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.054949,26.557503]},"properties":{"caseno":"13-0493","date":"5/4/2013","year":2013,"name":"Allen John Vachon","sex":"M","race":"W","age":"57","track":"FEC","type":"Accident","location":"Crossing (Vehicle)","impairment":"Alcohol; marijuana"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.056028,26.683309]},"properties":{"caseno":"13-0327","date":"3/24/2013","year":2013,"name":"Rosember Ortiz Perez","sex":"M","race":"W","age":"26","track":"FEC","type":"Accident","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.055691,26.696253]},"properties":{"caseno":"11-0025","date":"1/10/2011","year":2011,"name":"Bruce Edward Mone","sex":"M","race":"W","age":"52","track":"FEC","type":"Suicide","location":"Crossing","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.055376,26.708585]},"properties":{"caseno":"10-0497","date":"5/10/2010","year":2010,"name":"Douglas Fisher","sex":"M","race":"W","age":"26","track":"FEC","type":"Accident","location":"Crossing","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.068782,26.753353]},"properties":{"caseno":"09-1342","date":"12/16/2009","year":2009,"name":"Kareem Sondi Mayes","sex":"M","race":"B","age":"33","track":"CSX","type":"Suicide","location":"Pedestrian","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.056891,26.727304]},"properties":{"caseno":"12-0868","date":"9/1/2012","year":2012,"name":"Jerome Bell","sex":"M","race":"B","age":"65","track":"FEC","type":"Accident","location":"Crossing (Bicycle)","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.059462,26.615587]},"properties":{"caseno":"09-1018","date":"9/19/2009","year":2009,"name":"Mark Allen Layman","sex":"M","race":"W","age":"41","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.065136,26.74538]},"properties":{"caseno":"08-0485","date":"4/21/2008","year":2008,"name":"Earthell Allen","sex":"M","race":"B","age":"15","track":"CSX","type":"Accident","location":"ROW","impairment":"No"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.064608,26.736623]},"properties":{"caseno":"08-0889","date":"8/11/2008","year":2008,"name":"Levi McClendon","sex":"M","race":"B","age":"41","track":"CSX","type":"Accident","location":"Crossing","impairment":"Alcohol and cocaine"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.057508,26.60138]},"properties":{"caseno":"09-1378","date":"12/23/2009","year":2009,"name":"Eric Carter Dawson","sex":"M","race":"B","age":"42","track":"FEC","type":"Suicide","location":"Pedestrian","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.059353,26.763195]},"properties":{"caseno":"12-0251","date":"3/12/2012","year":2012,"name":"Tyrone Edward Epps","sex":"M","race":"B","age":"57","track":"FEC","type":"Accident","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.08852,26.949746]},"properties":{"caseno":"08-0420","date":"3/8/2008","year":2008,"name":"Rory Brown","sex":"M","race":"B","age":"28","track":"FEC","type":"Accident","location":"Crossing (Vehicle)","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.093992,26.931161]},"properties":{"caseno":"10-0825","date":"8/7/2010","year":2010,"name":"Esteban Gonzalez","sex":"M","race":"W","age":"28","track":"FEC","type":"Accident","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.060466,26.523124]},"properties":{"caseno":"09-1375","date":"12/23/2009","year":2009,"name":"Moreaut Hero","sex":"M","race":"B","age":"39","track":"FEC","type":"Unknown (but sure looks like an accident)","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.060123,26.754501]},"properties":{"caseno":"08-0656","date":"6/4/2008","year":2008,"name":"Felipe Martinez","sex":"M","race":"W","age":"33","track":"FEC","type":"Unknown","location":"ROW","impairment":"Alcohol"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.061850,26.514531]},"properties":{"caseno":"14-0035","date":"1/9/2014","year":2014,"name":"Dale Caniff","sex":"M","race":"W","age":"48","track":"FEC","type":"Unknown","location":"Unknown","impairment":"Alcohol, cocaine"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.062054,26.70151]},"properties":{"caseno":"08-0528","date":"5/3/2008","year":2008,"name":"Exequiel Lopez","sex":"M","race":"W","age":"25","track":"CSX","type":"Unknown","location":"ROW","impairment":"Alcohol"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.05537,26.70929]},"properties":{"caseno":"08-0941","date":"8/30/2008","year":2008,"name":"Ashleigh Scott Mitchell","sex":"M","race":"W","age":"36","track":"FEC","type":"Unknown","location":"ROW","impairment":"some alcohol"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.052272,26.588534]},"properties":{"caseno":"10-0976","date":"9/18/2010","year":2010,"name":"David Suppe","sex":"M","race":"W","age":"55","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.086757,26.358071]},"properties":{"caseno":"11-0954","date":"10/15/2011","year":2011,"name":"Douglas Shedd","sex":"M","race":"W","age":"39","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.055866,26.690358]},"properties":{"caseno":"08-0598","date":"5/20/2008","year":2008,"name":"Monica Stewart","sex":"F","race":"W","age":"37","track":"FEC","type":"Suicide","location":"Crossing","impairment":"Alcohol"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.07433,26.436358]},"properties":{"caseno":"09-0506","date":"5/5/2009","year":2009,"name":"Stefan Alexander Sessler","sex":"M","race":"W","age":"39","track":"FEC","type":"Suicide","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.090682,26.406554]},"properties":{"caseno":"08-0755","date":"7/2/2008","year":2008,"name":"Roy Ernest Risch","sex":"M","race":"W","age":"49","track":"CSX","type":"Accident","location":"ROW","impairment":"Alcohol"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.056916,26.72729]},"properties":{"caseno":"09-0676","date":"6/18/2009","year":2009,"name":"Donald East","sex":"M","race":"W","age":"53","track":"FEC","type":"Accident","location":"Other","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.064551,26.736676]},"properties":{"caseno":"10-0655","date":"6/22/2010","year":2010,"name":"Earvin Obrian Wilson","sex":"M","race":"B","age":"37","track":"CSX","type":"Accident","location":"Crossing","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.095149,26.842409]},"properties":{"caseno":"11-1060","date":"11/8/2011","year":2011,"name":"Robert Gassmann","sex":"M","race":"W","age":"44","track":"FEC","type":"Accident","location":"ROW","impairment":""}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.06523,26.747117]},"properties":{"caseno":"08-0170","date":"2/7/2008","year":2008,"name":"Mark Goldson","sex":"M","race":"B","age":"34","track":"CSX","type":"Accident","location":"ROW","impairment":"Marijuana"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-80.105126,26.777916]},"properties":{"caseno":"12-0716","date":"7/20/2012","year":2012,"name":"Manuel Morales","sex":"F","race":"W","age":"66","track":"CSX","type":"Accident","location":"Unknown","impairment":""}}]}

var scrollTargets= ["12-0437","12-0251","09-1375","13-0493","13-0631","08-0485"];
// extend icon class
var myIcon = L.Icon.extend({
    options: {        
    	iconSize: [10, 10],
    	iconAnchor: [5, 5],
    	className:"dot"
    }
});

var areIconsGrey = false;

//create three separate icons
var redIcon = new myIcon({iconUrl: 'http://www2.palmbeachpost.com/projects/news/trains/img/red.png'});
var yellowIcon = new myIcon({iconUrl: 'http://www2.palmbeachpost.com/projects/news/trains/img/yellow.png'});
var greyIcon = new myIcon({iconUrl: 'http://www2.palmbeachpost.com/projects/news/trains/img/grey.png'});
var highlightIcon = new myIcon(
		{iconUrl: 'http://www2.palmbeachpost.com/projects/news/trains/img/highlight.png',
		 iconSize: [16,16],
		 iconAnchor: [8,8]
		})
var zoomLevel = ($(window).width()<=480)? 8 : 13;

//get the baselayer map and store ref
map = L.mapbox.map('mapbox', 'kavyas.ijiejk97', {
	minZoom:8,
	maxZoom:15
})
.setView([26.336588, -80.091286],zoomLevel);
//map.dragging.disable();

//create a features layer to add points to
var incidentsLayer = L.mapbox.featureLayer().addTo(map);

//set eventhandlers and icons as layers are added
incidentsLayer.on('layeradd', function(e){
	var marker = e.layer;
	marker.on('mouseover', setMarker);
	marker.on('click', setMarker);
	marker.on('mouseout', resetMarker);
	setIncidentIcon(marker,false);
})

//Now add the points
incidentsLayer.setGeoJSON(geojsonData);
setupScrollSpy();

//handlers for picking the right icon
function setMarker(e){
	updateMarkerAndInfo(this);
}

function resetMarker(e){
	setIncidentIcon(this,false);
}

function updateMarkerAndInfo(marker){
	setIncidentIcon(marker,true)
	var prop = marker.feature.properties;
	$('#mapdetails #personname').text(prop.name);
	var $race = prop.race == "W" ? "white":"black";
	var $gender = prop.sex =="M"? " man":" woman";
	var $desc = prop.age+"-year-old "+$race+$gender;
	$('#mapdetails #desc').text($desc);
	$('#mapdetails #date').text("Date: "+prop.date);
}

function setIncidentIcon(marker, ishighlight){
	if(ishighlight)
	{
		marker.setIcon(highlightIcon);
		marker.setZIndexOffset(1000);
		return;
	}
	marker.setZIndexOffset(0);
	if(marker.feature.properties.type == "Accident")
		{
			marker.setIcon(redIcon);
	}else{
		marker.setIcon(yellowIcon);
	}
	return;
}

function setAllIconsGrey(layer){	
	layer.eachLayer(function(marker){
		marker.setIcon(greyIcon);
	});
	areIconsGrey = true;
}

function resetAllIcons(layer){
	layer.eachLayer(function(marker){
		setIncidentIcon(marker,false);
	});
	areIconsGrey = false;
}

function panMapTo(marker)
{
	var coords= marker.feature.geometry.coordinates;
	map.panTo([coords[1],coords[0]],{
		animate:true
	});
}

function findScrollTargets(caseno){
	return _.find(incidentsLayer.getLayers(),function(layer){ return layer.feature.properties.caseno == caseno;})
}

function setupScrollSpy(){	
	var $scrollTriggers = [
		{selector:"#eppsTrigger", caseno:"12-0251"},
		{selector:"#elanTrigger",caseno:"08-0606"},
		{selector:"#vachonTrigger", caseno:"13-0493"},
		{selector:"#septembreTrigger", caseno:"13-0631"},
		{selector:"#torresTrigger", caseno:"11-0125"},
		{selector:"#allenTrigger", caseno:"08-0485"},
		{selector:"#cuervoTrigger", caseno:"12-0437"}
	];
	_.each($scrollTriggers, function(element, index){
		$(element.selector).on('scrollSpy:enter',function(){
			resetAllIcons(incidentsLayer);
			var m = findScrollTargets(element.caseno);
			updateMarkerAndInfo(m);
			panMapTo(m);
		})
		$(element.selector).scrollSpy();
	});
}